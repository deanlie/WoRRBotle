#
# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(shiny)

#source("DisplayLetterTable.R")
#source("ButtonForKeyboardLetter.R")

# Define UI for application that draws a histogram
ui <- fluidPage(
    theme = bslib::bs_theme(bootswatch = "darkly"),
    
    includeCSS("www/wordleTable.css"),

    # Application title
    titlePanel("WoRRBottle -- sort of a Wordle Bot in R"),

    # Sidebar with the controls 
    sidebarLayout(
        sidebarPanel(
            textInput("Sought", "Answer!", "", '100px', ""),
            textInput("Guess1", NULL, "", '100px', "")
        ),

        # Show the feedback for the guesses so far
        mainPanel(
           fluidRow(column(width=6, offset=3,htmlOutput("letterTable"))),
           fluidRow(tags$table(tags$tr(buttonForKeyboardLetter("Q"),
                                       buttonForKeyboardLetter("W"),
                                       buttonForKeyboardLetter("E"),
                                       buttonForKeyboardLetter("R"),
                                       buttonForKeyboardLetter("T"),
                                       buttonForKeyboardLetter("Y"),
                                       buttonForKeyboardLetter("U"),
                                       buttonForKeyboardLetter("I"),
                                       buttonForKeyboardLetter("O"),
                                       buttonForKeyboardLetter("P")),
                               class="kbd")),
           fluidRow(tags$table(tags$tr(buttonForKeyboardLetter("A"),
                                       buttonForKeyboardLetter("S"),
                                       buttonForKeyboardLetter("D"),
                                       buttonForKeyboardLetter("F"),
                                       buttonForKeyboardLetter("G"),
                                       buttonForKeyboardLetter("H"),
                                       buttonForKeyboardLetter("J"),
                                       buttonForKeyboardLetter("K"),
                                       buttonForKeyboardLetter("L")),
                               class="kbd")),
           fluidRow(tags$table(tags$tr(buttonForKeyboardLetter("ENTER"),
                                       buttonForKeyboardLetter("Z"),
                                       buttonForKeyboardLetter("X"),
                                       buttonForKeyboardLetter("C"),
                                       buttonForKeyboardLetter("V"),
                                       buttonForKeyboardLetter("B"),
                                       buttonForKeyboardLetter("N"),
                                       buttonForKeyboardLetter("M"),
                                       buttonForKeyboardLetter("DELETE")),
                               class="kbd")))
    )
)

# NOTE! This is named "Keystroke" but it is only for alphabetical keys!
# "ENTER" and "DELETE" have their own handlers.
handleKeystroke <- function(rVals, aLetter) {
  if (rVals$guessNumber < 7) {
    if (rVals$nKeys < 5) {
      rVals$nKeys = rVals$nKeys + 1
      substr(rVals$Guesses[rVals$guessNumber], rVals$nKeys, rVals$nKeys) <- aLetter
      message("Words are now")
      for (i in 1:rVals$guessNumber) {
        message("  ", i, " ", rVals$Guesses[i])
      }
    } else {
      message("Too many keys, input ", aLetter, " ignored")
    }
  } else {
    message("No more guesses! Sorry, you lost.")
  }

  return(rVals)
}

# Define server logic for the game
server <- function(input, output) {
  
    r <- reactiveValues(nKeys = 0,
                        Guess = "     ",
                        guessNumber = 1,
                        Guesses = c("     ", "     ", "     ",
                                    "     ", "     ", "     "),
                        NeedsDisplay = FALSE,
                        Solved = FALSE)
    
    observeEvent(input$typedA, {
      r <- handleKeystroke(r, "A")
    })
    
    observeEvent(input$typedB, {
      r <- handleKeystroke(r, "B")
    })
    
    observeEvent(input$typedC, {
      r <- handleKeystroke(r, "C")
    })
    
    observeEvent(input$typedD, {
      r <- handleKeystroke(r, "D")
    })
    
    observeEvent(input$typedE, {
      r <- handleKeystroke(r, "E")
    })
    
    observeEvent(input$typedF, {
      r <- handleKeystroke(r, "F")
    })
    
    observeEvent(input$typedG, {
      r <- handleKeystroke(r, "G")
    })
    
    observeEvent(input$typedH, {
      r <- handleKeystroke(r, "H")
    })
    
    observeEvent(input$typedI, {
      r <- handleKeystroke(r, "I")
    })
    
    observeEvent(input$typedJ, {
      r <- handleKeystroke(r, "J")
    })
    
    observeEvent(input$typedK, {
      r <- handleKeystroke(r, "K")
    })
    
    observeEvent(input$typedL, {
      r <- handleKeystroke(r, "L")
    })
    
    observeEvent(input$typedM, {
      r <- handleKeystroke(r, "M")
    })
    
    observeEvent(input$typedN, {
      r <- handleKeystroke(r, "N")
    })
    
    observeEvent(input$typedO, {
      r <- handleKeystroke(r, "O")
    })
    
    observeEvent(input$typedP, {
      r <- handleKeystroke(r, "P")
    })
    
    observeEvent(input$typedQ, {
      r <- handleKeystroke(r, "Q")
    })
    
    observeEvent(input$typedR, {
      r <- handleKeystroke(r, "R")
    })
    
    observeEvent(input$typedS, {
      r <- handleKeystroke(r, "S")
    })
    
    observeEvent(input$typedT, {
      r <- handleKeystroke(r, "T")
    })
    
    observeEvent(input$typedU, {
      r <- handleKeystroke(r, "U")
    })
    
    observeEvent(input$typedV, {
      r <- handleKeystroke(r, "V")
    })
    
    observeEvent(input$typedW, {
      r <- handleKeystroke(r, "W")
    })
    
    observeEvent(input$typedX, {
      r <- handleKeystroke(r, "X")
    })
    
    observeEvent(input$typedY, {
      r <- handleKeystroke(r, "Y")
    })
    
    observeEvent(input$typedZ, {
      r <- handleKeystroke(r, "Z")
    })
    
    observeEvent(input$typedENTER, {
      if (r$nKeys < 5) {
        message("You can't enter an incomplete guess!")
      } else {
        # OUCH score that and redisplay the row (or, I guess, all letter rows)
        if (r$guessNumber < 7) {
          r$nKeys <- 0
          r$guessNumber <- r$guessNumber + 1
        } else {
          message("No more guesses! Sorry, you lost.")
          # OUCH Game is over!
        }
      }
    })
    
    observeEvent(input$typedDELETE, {
      if (r$nKeys > 0) {
        substr(r$Guesses[r$guessNumber], r$nKeys, r$nKeys) <- " "
        message("Active word is now ", r$Guesses[r$guessNumber])
        r$nKeys <- r$nKeys - 1
      }
    })

    output$letterTable <- renderUI({
      # sought, guessArray, rowIndex, incompleteWordIndex
      message("input$sought ", input$Sought)
      message("r$guessNumber ", r$guessNumber)
      letterTableToDisplay(input$Sought,
                           r$Guesses,
                           r$guessNumber)
    })
}

# Run the application 
shinyApp(ui = ui, server = server)
